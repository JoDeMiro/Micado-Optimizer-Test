#cloud-config

packages:
  - git
  - openssh-client


write_files:
- path: /bin/worker-add-user.sh
  content: |
    #!/bin/bash
    export USR='ubuntu'
    echo "---------------> Creating user \"$USR\" starts."
    adduser --disabled-password --gecos "" $USR
    echo "---------------> Creating user \"$USR\" finished."
  permissions: '755'

- path: /bin/worker-add-base-tools.sh
  content: |
    #!/bin/bash
    echo "---------------> Installing base tools (pip,venv) starts."
    echo "---------------> Installing base tools (pip,venv) finished."
  permissions: '755'

- path: /bin/worker-install.sh
  content: |
    #!/bin/bash
    echo "---------------> Install Java stuffs for me."
    sudo apt-get update -y
    sudo apt install -y apache2
    sudo apt install -y libapache2-mod-jk
    sudo ufw app list
    sudo ufw allow 'Apache'
    sudo ufw status
    sudo a2enmod proxy
    sudo a2enmod proxy_http
    sudo a2enmod proxy_balancer
    sudo a2enmod lbmethod_byrequests
    sudo a2enmod slotmem_shm
    sudo apt install -y ntpdate tmux collectl moreutils
    sudo ntpdate -s time.nist.gov
    sudo systemctl restart apache2
    ls -l /home/ubuntu/.local/bin
    export PATH=$PATH:/home/ubuntu/.local/bin
    
    # Load Balancer for Java TomCat

    # https://madurad.wordpress.com/2014/08/27/tomcat-server-loab-balancing-using-multiple-tomcat-server-instances-in-ubuntu
    # https://www.xmodulo.com/configure-tomcat-cluster-ubuntu.html
    # https://medium.com/@sanjayadesilva6/setting-up-apache-loadbalancer-46072177ec66
    # https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-18-04-quickstart
    # https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-20-04
    # https://ubuntu.com/tutorials/install-and-configure-apache#5-activating-virtualhost-file
    # https://httpd.apache.org/docs/2.4/mod/mod_proxy_balancer.html
    # https://stackoverflow.com/questions/52433480/spring-boot-application-load-balanced-with-apache

    # http://193.2xx.xxx.xxx/balancer-manager/myapp
    
    sudo mkdir /var/www/loadbalancer
    sudo chown -R $USER:$USER /var/www/loadbalancer
    sudo chmod -R 755 /var/www/loadbalancer
    
    wget https://raw.githubusercontent.com/JoDeMiro/Micado-Optimizer-Test/main/loadbalancer.conf
    sudo cp loadbalancer.conf /etc/apache2/sites-available/loadbalancer.conf
    sudo systemctl reload apache2

    echo "---------------> Get Micado-Optimizer-Tes Project"

    # git clone https://github.com/JoDeMiro/Micado-Optimizer-Test.git
    # mvn spring-boot:run

    echo "---------------> Get Micado-Optimizer-Test Project finished."
  permissions: '755'


runcmd:
- echo "---------------> JoDeMiro Deployment starts."
- /bin/worker-add-base-tools.sh
- su - ubuntu -c /bin/worker-install.sh
- echo "---------------> JoDeMiro Deployment finished."
